{% extends "base.html" %}

{% block title %}Rake Details - {{ rake_info[0] }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('admin_summary') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Summary
    </a>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-train-freight-front"></i> Rake Details: {{ rake_info[0] }}</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Company:</strong> {{ rake_info[1] }}</p>
                {% if rake_products and rake_products|length > 1 %}
                <p><strong>Products:</strong></p>
                <ul class="list-unstyled ms-3">
                    {% for product in rake_products %}
                    <li><i class="bi bi-box-seam text-primary"></i> {{ product[2] }} ({{ product[3] }}) - {{ "%.2f"|format(product[4]) }} MT</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p><strong>Product:</strong> {{ rake_info[2] }}</p>
                {% endif %}
                <p><strong>Date:</strong> {{ rake_info[3] }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>RR Quantity:</strong> {{ "%.2f"|format(rake_info[4]|float) }} MT</p>
                <p><strong>Rake Point:</strong> {{ rake_info[5] }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Stock Dispatched to Accounts -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Dispatched to Accounts (Dealers/Retailers) - Total: {{ "%.2f"|format(total_to_accounts) }} MT</h5>
    </div>
    <div class="card-body">
        {% if account_dispatches %}
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Account Name</th>
                        <th>Type</th>
                        <th>Total Quantity (MT)</th>
                        <th>Builties</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dispatch in account_dispatches %}
                    <tr>
                        <td><strong>{{ dispatch[0] }}</strong></td>
                        <td><span class="badge bg-secondary">{{ dispatch[1] }}</span></td>
                        <td class="text-end text-primary"><strong>{{ "%.2f"|format(dispatch[2]) }} MT</strong></td>
                        <td class="text-center">{{ dispatch[3] }}</td>
                        <td><small class="text-muted">{{ dispatch[4][:100] + '...' if dispatch[4] and dispatch[4]|length > 100 else dispatch[4] or '-' }}</small></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-light fw-bold">
                        <td colspan="2">TOTAL TO ACCOUNTS</td>
                        <td class="text-end">{{ "%.2f"|format(total_to_accounts) }} MT</td>
                        <td colspan="2"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No stock dispatched to accounts for this rake.</p>
        {% endif %}
    </div>
</div>

<!-- Stock Dispatched to Warehouses -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-building"></i> Dispatched to Warehouses - Total: {{ "%.2f"|format(total_to_warehouses) }} MT</h5>
    </div>
    <div class="card-body">
        {% if warehouse_dispatches %}
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Warehouse Name</th>
                        <th>Location</th>
                        <th>Total Quantity (MT)</th>
                        <th>Builties</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dispatch in warehouse_dispatches %}
                    <tr>
                        <td><strong>{{ dispatch[0] }}</strong></td>
                        <td>{{ dispatch[1] }}</td>
                        <td class="text-end text-warning"><strong>{{ "%.2f"|format(dispatch[2]) }} MT</strong></td>
                        <td class="text-center">{{ dispatch[3] }}</td>
                        <td><small class="text-muted">{{ dispatch[4][:100] + '...' if dispatch[4] and dispatch[4]|length > 100 else dispatch[4] or '-' }}</small></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-light fw-bold">
                        <td colspan="2">TOTAL TO WAREHOUSES</td>
                        <td class="text-end">{{ "%.2f"|format(total_to_warehouses) }} MT</td>
                        <td colspan="2"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No stock dispatched to warehouses for this rake.</p>
        {% endif %}
    </div>
</div>

<!-- Stock Dispatched to CGMF -->
{% if cgmf_dispatches %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-building-check"></i> Dispatched to CGMF (CG Markfed) - Total: {{ "%.2f"|format(total_to_cgmf) }} MT</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Society Name</th>
                        <th>District</th>
                        <th>Destination</th>
                        <th>Total Quantity (MT)</th>
                        <th>Builties</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dispatch in cgmf_dispatches %}
                    <tr>
                        <td><strong>{{ dispatch[0] }}</strong></td>
                        <td>{{ dispatch[1] }}</td>
                        <td>{{ dispatch[2] }}</td>
                        <td class="text-end text-success"><strong>{{ "%.2f"|format(dispatch[3]) }} MT</strong></td>
                        <td class="text-center">{{ dispatch[4] }}</td>
                        <td><small class="text-muted">{{ dispatch[5][:100] + '...' if dispatch[5] and dispatch[5]|length > 100 else dispatch[5] or '-' }}</small></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-light fw-bold">
                        <td colspan="3">TOTAL TO CGMF</td>
                        <td class="text-end">{{ "%.2f"|format(total_to_cgmf) }} MT</td>
                        <td colspan="2"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Summary Card -->
<div class="card">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Rake Dispatch Summary</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted">RR Quantity</h6>
                    <h4 class="text-dark">{{ "%.2f"|format(rake_info[4]|float) }} MT</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 border rounded bg-info bg-opacity-10">
                    <h6 class="text-muted">To Accounts</h6>
                    <h4 class="text-info">{{ "%.2f"|format(total_to_accounts) }} MT</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 border rounded bg-warning bg-opacity-10">
                    <h6 class="text-muted">To Warehouses</h6>
                    <h4 class="text-warning">{{ "%.2f"|format(total_to_warehouses) }} MT</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 border rounded bg-success bg-opacity-10">
                    <h6 class="text-muted">To CGMF</h6>
                    <h4 class="text-success">{{ "%.2f"|format(total_to_cgmf|default(0)) }} MT</h4>
                </div>
            </div>
        </div>
        <hr>
        <div class="row text-center mt-3">
            <div class="col-md-6">
                <div class="p-3 border rounded bg-primary bg-opacity-10">
                    <h6 class="text-muted">Total Dispatched</h6>
                    <h4 class="text-primary">{{ "%.2f"|format(total_to_accounts + total_to_warehouses + (total_to_cgmf|default(0))) }} MT</h4>
                </div>
            </div>
            <div class="col-md-6">
                {% set total_dispatched = total_to_accounts + total_to_warehouses + (total_to_cgmf|default(0)) %}
                {% set remaining = rake_info[4]|float - total_dispatched %}
                <div class="p-3 border rounded {% if remaining > 0 %}bg-danger{% else %}bg-success{% endif %} bg-opacity-10">
                    <h6 class="text-muted">Remaining in Rake</h6>
                    <h4 class="{% if remaining > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ "%.2f"|format(remaining) }} MT
                    </h4>
                    <small class="text-muted">
                        (RR: {{ "%.2f"|format(rake_info[4]|float) }} MT - Dispatched: {{ "%.2f"|format(total_dispatched) }} MT)
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('admin_summary') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Summary
    </a>
    <a href="{{ url_for('admin_download_rake_details_excel', rake_code=rake_info[0]) }}" class="btn btn-success">
        <i class="bi bi-file-earmark-excel"></i> Download Excel
    </a>
    <button class="btn btn-outline-primary" onclick="window.print()">
        <i class="bi bi-printer"></i> Print Page
    </button>
</div>
{% endblock %}
