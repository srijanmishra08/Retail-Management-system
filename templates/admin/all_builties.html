{% extends "base.html" %}

{% block title %}All Builties - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-earmark-text"></i> All Builties</h2>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> Filters</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="rakeFilter" class="form-label">Rake Code</label>
                    <select class="form-select" id="rakeFilter">
                        <option value="">All Rakes</option>
                        {% for rake in rakes %}
                        <option value="{{ rake[1] }}">{{ rake[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="truckFilter" class="form-label">Truck Number</label>
                    <select class="form-select" id="truckFilter">
                        <option value="">All Trucks</option>
                        {% for truck in trucks %}
                        <option value="{{ truck[1] }}">{{ truck[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="destinationFilter" class="form-label">Destination</label>
                    <select class="form-select" id="destinationFilter">
                        <option value="">All Destinations</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse[1] }}">{{ warehouse[1] }} (Warehouse)</option>
                        {% endfor %}
                        {% for cgmf in cgmf_list %}
                        <option value="{{ cgmf[1] }}">{{ cgmf[1] }} (CGMF)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="accountFilter" class="form-label">Account</label>
                    <select class="form-select" id="accountFilter">
                        <option value="">All Accounts</option>
                        <optgroup label="Dealers">
                            {% for account in accounts if account[2] == 'Dealer' %}
                            <option value="{{ account[1] }}">{{ account[1] }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Retailers">
                            {% for account in accounts if account[2] == 'Retailer' %}
                            <option value="{{ account[1] }}">{{ account[1] }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Warehouses">
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse[1] }}">{{ warehouse[1] }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="CGMF">
                            {% for cgmf in cgmf_list %}
                            <option value="{{ cgmf[1] }}">{{ cgmf[1] }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search...">
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="builtiesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Builty ID</th>
                            <th>Builty Number</th>
                            <th>Rake Code</th>
                            <th>Date</th>
                            <th>LR Number</th>
                            <th>Goods</th>
                            <th>Bags</th>
                            <th>Quantity (MT)</th>
                            <th>Rate/MT</th>
                            <th>Total Freight</th>
                            <th>Truck</th>
                            <th>Destination</th>
                            <th>Account</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for builty in builties %}
                        <tr data-rake="{{ builty[2] or '' }}" data-truck="{{ builty[28] or '' }}" data-destination="{{ builty[10] or '' }}" data-account="{{ builty[26] or builty[27] or builty[29] or '' }}">
                            <td>{{ builty[0] }}</td>
                            <td><strong>{{ builty[1] }}</strong></td>
                            <td>{{ builty[2] or 'N/A' }}</td>
                            <td>{{ builty[3]|format_date if builty[3] else 'N/A' }}</td>
                            <td>{{ builty[19] if builty[19] else 'N/A' }}</td>
                            <td>{{ builty[11] }}</td>
                            <td>{{ builty[12] }}</td>
                            <td>{{ builty[13] }} MT</td>
                            <td>₹{{ "{:,.2f}".format(builty[15] if builty[15] else 0) }}</td>
                            <td>₹{{ "{:,.2f}".format(builty[16] if builty[16] else 0) }}</td>
                            <td>{{ builty[28] if builty[28] else 'N/A' }}</td>
                            <td>{{ builty[10] if builty[10] else '-' }}</td>
                            <td>
                                {% if builty[26] %}
                                    <span class="badge bg-info">{{ builty[26] }}</span>
                                {% elif builty[27] %}
                                    <span class="badge bg-warning text-dark">{{ builty[27] }}</span>
                                {% elif builty[29] %}
                                    <span class="badge bg-success">{{ builty[29] }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ builty[25]|format_date if builty[25] else 'N/A' }}</td>
                            <td>
                                <a href="{{ url_for('admin_print_builty', builty_id=builty[0]) }}" 
                                   class="btn btn-sm btn-primary" 
                                   target="_blank" 
                                   title="Print Builty">
                                    <i class="bi bi-printer"></i>
                                </a>
                                <a href="{{ url_for('admin_print_builty', builty_id=builty[0]) }}" 
                                   class="btn btn-sm btn-success ms-1" 
                                   target="_blank" 
                                   title="Download Builty"
                                   onclick="event.preventDefault(); downloadBuilty('{{ url_for('admin_print_builty', builty_id=builty[0]) }}');">
                                    <i class="bi bi-download"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-warning ms-1" 
                                        title="Edit Builty"
                                        onclick="openEditBuiltyModal({{ builty[0] }}, '{{ builty[10] if builty[10] else '' }}', {{ builty[12] }}, {{ builty[13] }}, {{ builty[15] if builty[15] else 0 }}, {{ builty[16] if builty[16] else 0 }}, {{ builty[17] if builty[17] else 0 }}, {{ builty[18] if builty[18] else 0 }}, '{{ builty[3] if builty[3] else '' }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger ms-1" 
                                        title="Delete Builty"
                                        onclick="confirmDeleteBuilty({{ builty[0] }}, '{{ builty[1] }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if not builties %}
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle"></i> No builties found in the system.
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteBuiltyModal" tabindex="-1" aria-labelledby="deleteBuiltyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteBuiltyModalLabel"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteBuiltyForm" method="POST">
                <div class="modal-body">
                    <p>Are you sure you want to delete builty <strong id="builtyNumberToDelete"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> This will:
                        <ul class="mb-0 mt-2">
                            <li>Delete the builty record</li>
                            <li>Remove associated warehouse stock entries</li>
                        </ul>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="delete_loading_slip" value="true" id="deleteLinkedLoadingSlip">
                        <label class="form-check-label" for="deleteLinkedLoadingSlip">
                            Also delete linked loading slip (if any)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Builty Modal -->
<div class="modal fade" id="editBuiltyModal" tabindex="-1" aria-labelledby="editBuiltyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editBuiltyModalLabel"><i class="bi bi-pencil"></i> Edit Builty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBuiltyForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Editing quantity will affect the warehouse stock calculation.
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="edit_unloading_type" class="form-label">Unloading Point Type</label>
                            <select class="form-select" id="edit_unloading_type" onchange="toggleUnloadingOptions()">
                                <option value="account">Account (Dealer/Retailer)</option>
                                <option value="warehouse">Warehouse</option>
                                <option value="cgmf">CGMF (Markfed)</option>
                                <option value="manual">Manual Entry</option>
                            </select>
                        </div>
                        <div class="col-md-8 mb-3" id="edit_builty_account_div">
                            <label for="edit_builty_account_select" class="form-label">Select Account</label>
                            <select class="form-select" id="edit_builty_account_select" name="account_id">
                                <option value="">-- Select Account --</option>
                                {% for account in accounts %}
                                <option value="{{ account[0] }}" data-name="{{ account[1] }}">{{ account[1] }} ({{ account[2] }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8 mb-3" id="edit_builty_warehouse_div" style="display: none;">
                            <label for="edit_builty_warehouse_select" class="form-label">Select Warehouse</label>
                            <select class="form-select" id="edit_builty_warehouse_select" name="warehouse_id">
                                <option value="">-- Select Warehouse --</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse[0] }}" data-name="{{ warehouse[1] }}">{{ warehouse[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8 mb-3" id="edit_builty_cgmf_div" style="display: none;">
                            <label for="edit_builty_cgmf_select" class="form-label">Select CGMF Society</label>
                            <select class="form-select" id="edit_builty_cgmf_select" name="cgmf_id">
                                <option value="">-- Select CGMF --</option>
                                {% for cgmf in cgmf_list %}
                                <option value="{{ cgmf[0] }}" data-name="{{ cgmf[3] }}">{{ cgmf[3] }} - {{ cgmf[2] }} ({{ cgmf[1] }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8 mb-3" id="edit_builty_manual_div" style="display: none;">
                            <label for="edit_unloading_point" class="form-label">Unloading Point (Manual)</label>
                            <input type="text" class="form-control" id="edit_unloading_point" name="unloading_point">
                        </div>
                    </div>
                    <input type="hidden" id="edit_unloading_hidden" name="unloading_point_final">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="edit_number_of_bags" class="form-label">Number of Bags</label>
                            <input type="number" class="form-control" id="edit_number_of_bags" name="number_of_bags" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_quantity_mt" class="form-label">Quantity (MT)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_quantity_mt" name="quantity_mt" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_rate_per_mt" class="form-label">Rate/MT (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_rate_per_mt" name="rate_per_mt">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_total_freight" class="form-label">Total Freight (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_total_freight" name="total_freight">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_advance" class="form-label">Advance (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_advance" name="advance">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_to_pay" class="form-label">To Pay (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_to_pay" name="to_pay">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_builty_date" class="form-label">Builty Date</label>
                            <input type="date" class="form-control" id="edit_builty_date" name="date">
                            <small class="text-muted">Leave empty to keep current date</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="setUnloadingValue()"><i class="bi bi-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Filter functionality
    function applyFilters() {
        const rakeFilter = document.getElementById('rakeFilter').value;
        const truckFilter = document.getElementById('truckFilter').value;
        const destinationFilter = document.getElementById('destinationFilter').value;
        const accountFilter = document.getElementById('accountFilter').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        
        const table = document.getElementById('builtiesTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const rake = row.dataset.rake || '';
            const truck = row.dataset.truck || '';
            const destination = row.dataset.destination || '';
            const account = row.dataset.account || '';
            const text = row.textContent.toLowerCase();
            
            const matchRake = !rakeFilter || rake === rakeFilter;
            const matchTruck = !truckFilter || truck === truckFilter;
            const matchDestination = !destinationFilter || destination.includes(destinationFilter);
            const matchAccount = !accountFilter || account.includes(accountFilter);
            const matchSearch = !searchText || text.includes(searchText);
            
            row.style.display = (matchRake && matchTruck && matchDestination && matchAccount && matchSearch) ? '' : 'none';
        }
    }
    
    function clearFilters() {
        document.getElementById('rakeFilter').value = '';
        document.getElementById('truckFilter').value = '';
        document.getElementById('destinationFilter').value = '';
        document.getElementById('accountFilter').value = '';
        document.getElementById('searchInput').value = '';
        applyFilters();
    }
    
    // Add event listeners to filters
    document.getElementById('rakeFilter').addEventListener('change', applyFilters);
    document.getElementById('truckFilter').addEventListener('change', applyFilters);
    document.getElementById('destinationFilter').addEventListener('change', applyFilters);
    document.getElementById('accountFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('keyup', applyFilters);
    
    // Download builty function - opens in new window and triggers print/save as PDF
    function downloadBuilty(url) {
        const win = window.open(url, '_blank');
        win.addEventListener('load', function() {
            setTimeout(() => win.print(), 500);
        });
    }
    
    // Delete builty confirmation
    function confirmDeleteBuilty(builtyId, builtyNumber) {
        document.getElementById('builtyNumberToDelete').textContent = builtyNumber;
        document.getElementById('deleteBuiltyForm').action = '/admin/delete-builty/' + builtyId;
        new bootstrap.Modal(document.getElementById('deleteBuiltyModal')).show();
    }
    
    // Edit builty modal
    function openEditBuiltyModal(builtyId, unloadingPoint, bags, mt, rate, freight, advance, toPay, dateStr) {
        document.getElementById('editBuiltyForm').action = '/admin/edit-builty/' + builtyId;
        document.getElementById('edit_unloading_point').value = unloadingPoint || '';
        document.getElementById('edit_number_of_bags').value = bags;
        document.getElementById('edit_quantity_mt').value = mt;
        document.getElementById('edit_rate_per_mt').value = rate;
        document.getElementById('edit_total_freight').value = freight;
        document.getElementById('edit_advance').value = advance;
        document.getElementById('edit_to_pay').value = toPay;
        
        // Set date field if provided (take first 10 chars for YYYY-MM-DD)
        const dateField = document.getElementById('edit_builty_date');
        if (dateStr && dateStr.length >= 10) {
            dateField.value = dateStr.substring(0, 10);
        } else {
            dateField.value = '';
        }
        
        // Reset to manual entry by default with current unloading point
        document.getElementById('edit_unloading_type').value = 'manual';
        toggleUnloadingOptions();
        
        new bootstrap.Modal(document.getElementById('editBuiltyModal')).show();
    }
    
    // Toggle unloading options based on type
    function toggleUnloadingOptions() {
        const type = document.getElementById('edit_unloading_type').value;
        document.getElementById('edit_builty_account_div').style.display = type === 'account' ? 'block' : 'none';
        document.getElementById('edit_builty_warehouse_div').style.display = type === 'warehouse' ? 'block' : 'none';
        document.getElementById('edit_builty_cgmf_div').style.display = type === 'cgmf' ? 'block' : 'none';
        document.getElementById('edit_builty_manual_div').style.display = type === 'manual' ? 'block' : 'none';
        
        // Clear selections
        if (type !== 'account') document.getElementById('edit_builty_account_select').value = '';
        if (type !== 'warehouse') document.getElementById('edit_builty_warehouse_select').value = '';
        if (type !== 'cgmf') document.getElementById('edit_builty_cgmf_select').value = '';
    }
    
    // Set unloading point value before form submit
    function setUnloadingValue() {
        const type = document.getElementById('edit_unloading_type').value;
        let destValue = '';
        
        if (type === 'account') {
            const select = document.getElementById('edit_builty_account_select');
            destValue = select.options[select.selectedIndex]?.dataset.name || '';
        } else if (type === 'warehouse') {
            const select = document.getElementById('edit_builty_warehouse_select');
            destValue = select.options[select.selectedIndex]?.dataset.name || '';
        } else if (type === 'cgmf') {
            const select = document.getElementById('edit_builty_cgmf_select');
            destValue = select.options[select.selectedIndex]?.dataset.name || '';
        } else {
            destValue = document.getElementById('edit_unloading_point').value;
        }
        
        document.getElementById('edit_unloading_hidden').value = destValue;
    }
</script>
{% endblock %}
