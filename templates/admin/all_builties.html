{% extends "base.html" %}

{% block title %}All Builties - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-earmark-text"></i> All Builties</h2>
        <div>
            <input type="text" id="searchInput" class="form-control" placeholder="Search..." style="width: 300px;">
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="builtiesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Builty ID</th>
                            <th>Builty Number</th>
                            <th>Date</th>
                            <th>LR Number</th>
                            <th>Goods</th>
                            <th>Bags</th>
                            <th>Quantity (MT)</th>
                            <th>Rate/MT</th>
                            <th>Total Freight</th>
                            <th>Truck</th>
                            <th>Account</th>
                            <th>Warehouse</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for builty in builties %}
                        <tr>
                            <td>{{ builty[0] }}</td>
                            <td><strong>{{ builty[1] }}</strong></td>
                            <td>{{ builty[3][:10] if builty[3] else 'N/A' }}</td>
                            <td>{{ builty[19] if builty[19] else 'N/A' }}</td>
                            <td>{{ builty[11] }}</td>
                            <td>{{ builty[12] }}</td>
                            <td>{{ builty[13] }} MT</td>
                            <td>₹{{ "{:,.2f}".format(builty[15] if builty[15] else 0) }}</td>
                            <td>₹{{ "{:,.2f}".format(builty[16] if builty[16] else 0) }}</td>
                            <td>{{ builty[26] if builty[26] else 'N/A' }}</td>
                            <td>{{ builty[24] if builty[24] else 'N/A' }}</td>
                            <td>{{ builty[25] if builty[25] else 'N/A' }}</td>
                            <td>{{ builty[22][:16] if builty[22] else 'N/A' }}</td>
                            <td>
                                <a href="{{ url_for('admin_print_builty', builty_id=builty[0]) }}" 
                                   class="btn btn-sm btn-primary" 
                                   target="_blank" 
                                   title="Print Builty">
                                    <i class="bi bi-printer"></i>
                                </a>
                                <a href="{{ url_for('admin_print_builty', builty_id=builty[0]) }}" 
                                   class="btn btn-sm btn-success ms-1" 
                                   target="_blank" 
                                   title="Download Builty"
                                   onclick="event.preventDefault(); downloadBuilty('{{ url_for('admin_print_builty', builty_id=builty[0]) }}');">
                                    <i class="bi bi-download"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-warning ms-1" 
                                        title="Edit Builty"
                                        onclick="openEditBuiltyModal({{ builty[0] }}, '{{ builty[10] if builty[10] else '' }}', {{ builty[12] }}, {{ builty[13] }}, {{ builty[15] if builty[15] else 0 }}, {{ builty[16] if builty[16] else 0 }}, {{ builty[17] if builty[17] else 0 }}, {{ builty[18] if builty[18] else 0 }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger ms-1" 
                                        title="Delete Builty"
                                        onclick="confirmDeleteBuilty({{ builty[0] }}, '{{ builty[1] }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if not builties %}
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle"></i> No builties found in the system.
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteBuiltyModal" tabindex="-1" aria-labelledby="deleteBuiltyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteBuiltyModalLabel"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteBuiltyForm" method="POST">
                <div class="modal-body">
                    <p>Are you sure you want to delete builty <strong id="builtyNumberToDelete"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> This will:
                        <ul class="mb-0 mt-2">
                            <li>Delete the builty record</li>
                            <li>Remove associated warehouse stock entries</li>
                        </ul>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="delete_loading_slip" value="true" id="deleteLinkedLoadingSlip">
                        <label class="form-check-label" for="deleteLinkedLoadingSlip">
                            Also delete linked loading slip (if any)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Builty Modal -->
<div class="modal fade" id="editBuiltyModal" tabindex="-1" aria-labelledby="editBuiltyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editBuiltyModalLabel"><i class="bi bi-pencil"></i> Edit Builty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBuiltyForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Editing quantity will affect the warehouse stock calculation.
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_unloading_point" class="form-label">Unloading Point</label>
                            <input type="text" class="form-control" id="edit_unloading_point" name="unloading_point">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_number_of_bags" class="form-label">Number of Bags</label>
                            <input type="number" class="form-control" id="edit_number_of_bags" name="number_of_bags" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_quantity_mt" class="form-label">Quantity (MT)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_quantity_mt" name="quantity_mt" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="edit_rate_per_mt" class="form-label">Rate/MT (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_rate_per_mt" name="rate_per_mt">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_total_freight" class="form-label">Total Freight (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_total_freight" name="total_freight">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_advance" class="form-label">Advance (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_advance" name="advance">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit_to_pay" class="form-label">To Pay (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_to_pay" name="to_pay">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="bi bi-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchText = this.value.toLowerCase();
        const table = document.getElementById('builtiesTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchText) ? '' : 'none';
        }
    });
    
    // Download builty function - opens in new window and triggers print/save as PDF
    function downloadBuilty(url) {
        const win = window.open(url, '_blank');
        win.addEventListener('load', function() {
            setTimeout(() => win.print(), 500);
        });
    }
    
    // Delete builty confirmation
    function confirmDeleteBuilty(builtyId, builtyNumber) {
        document.getElementById('builtyNumberToDelete').textContent = builtyNumber;
        document.getElementById('deleteBuiltyForm').action = '/admin/delete-builty/' + builtyId;
        new bootstrap.Modal(document.getElementById('deleteBuiltyModal')).show();
    }
    
    // Edit builty modal
    function openEditBuiltyModal(builtyId, unloadingPoint, bags, mt, rate, freight, advance, toPay) {
        document.getElementById('editBuiltyForm').action = '/admin/edit-builty/' + builtyId;
        document.getElementById('edit_unloading_point').value = unloadingPoint || '';
        document.getElementById('edit_number_of_bags').value = bags;
        document.getElementById('edit_quantity_mt').value = mt;
        document.getElementById('edit_rate_per_mt').value = rate;
        document.getElementById('edit_total_freight').value = freight;
        document.getElementById('edit_advance').value = advance;
        document.getElementById('edit_to_pay').value = toPay;
        new bootstrap.Modal(document.getElementById('editBuiltyModal')).show();
    }
</script>
{% endblock %}
