{% extends "base.html" %}

{% block title %}Stock IN - FIMS{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('warehouse_dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="card">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-arrow-down-circle"></i> Stock IN Entry</h4>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('warehouse_stock_in') }}">
            <!-- Serial Number (Auto-generated, readonly) -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="serial_number" class="form-label">Serial No. <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-light" id="serial_number" name="serial_number" readonly placeholder="Auto-generated">
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="stock_in_date" class="form-label">Stock IN Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="stock_in_date" name="stock_in_date" required>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="warehouse_name" class="form-label">Warehouse <span class="text-danger">*</span></label>
                    <select class="form-select" id="warehouse_name" name="warehouse_name" required>
                        <option value="">Select Warehouse</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse[0] }}">{{ warehouse[1] }} - {{ warehouse[2] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <hr>
            
            <!-- Source Type Selection -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Source Type <span class="text-danger">*</span></label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="source_type" id="source_rake" value="rake" checked>
                        <label class="btn btn-outline-primary" for="source_rake">
                            <i class="bi bi-train-freight-front"></i> From Rake (Builty)
                        </label>
                        
                        <input type="radio" class="btn-check" name="source_type" id="source_truck" value="truck">
                        <label class="btn btn-outline-success" for="source_truck">
                            <i class="bi bi-truck"></i> From Truck (Direct)
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Rake/Builty Section -->
            <div id="rake_section">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="builty_number" class="form-label">Builty Number (Sent to Warehouse)</label>
                        <select class="form-select" id="builty_number" name="builty_number">
                            <option value="">Select Builty</option>
                            {% for builty in builties %}
                            <option value="{{ builty[0] }}" 
                                    data-goods="{{ builty[10] }}" 
                                    data-quantity="{{ builty[12] }}"
                                    data-warehouse="{{ builty.dest_warehouse_name if builty.dest_warehouse_name else builty[-1] }}">
                                {{ builty[1] }} - {{ builty[10] }} ({{ "%.2f"|format(builty[12]) }} MT) â†’ {{ builty.dest_warehouse_name if builty.dest_warehouse_name else builty[-1] }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Only showing builties sent to warehouses from Rakepoint</small>
                    </div>
                </div>
            </div>
            
            <!-- Truck Section (Hidden by default) -->
            <div id="truck_section" style="display:none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="truck_number" class="form-label">Truck Number</label>
                        <select class="form-select" id="truck_number" name="truck_number">
                            <option value="">Select Truck</option>
                            {% for truck in trucks %}
                            <option value="{{ truck[0] }}">{{ truck[1] }} - {{ truck[2] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <!-- Product and Company Details -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="company_id" class="form-label">Company <span class="text-danger">*</span></label>
                    <select class="form-select" id="company_id" name="company_id" required>
                        <option value="">Select Company</option>
                        {% for company in companies %}
                        <option value="{{ company[0] }}">{{ company[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="product_id" class="form-label">Product <span class="text-danger">*</span></label>
                    <select class="form-select" id="product_id" name="product_id" required>
                        <option value="">Select Product</option>
                        {% for product in products %}
                        <option value="{{ product[0] }}">{{ product[1] }} ({{ product[3] }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="unloaded_quantity" class="form-label">Quantity (MT) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" class="form-control" id="unloaded_quantity" name="unloaded_quantity" required placeholder="0.00">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="employee_id" class="form-label">Employee <span class="text-danger">*</span></label>
                    <select class="form-select" id="employee_id" name="employee_id" required>
                        <option value="">Select Employee</option>
                        {% for employee in employees %}
                        <option value="{{ employee[0] }}">{{ employee[1] }} - {{ employee[4] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="account_id" class="form-label">Account / CGMF <span class="text-danger">*</span></label>
                    <select class="form-select" id="account_id" name="account_id" required onchange="toggleSubHead()">
                        <option value="">-- Select Account/CGMF --</option>
                        <optgroup label="ðŸ‘¥ Accounts (Dealers/Retailers)">
                            {% for account in accounts %}
                            <option value="{{ account[0] }}" data-type="{{ account[2] }}">{{ account[1] }} - {{ account[2] }}</option>
                            {% endfor %}
                        </optgroup>
                        {% if cgmf_list %}
                        <optgroup label="ðŸ›ï¸ CGMF (CG Markfed)">
                            {% for cgmf in cgmf_list %}
                            <option value="CGMF:{{ cgmf[0] }}" data-type="CGMF">{{ cgmf[3] }} - {{ cgmf[1] }} ({{ cgmf[2] }})</option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                    </select>
                    <small class="form-text text-muted">Select the account or CGMF society this stock belongs to</small>
                </div>
                
                <!-- Sub Head field (shown only for Payal accounts) -->
                <div class="col-md-6 mb-3" id="sub_head_container" style="display: none;">
                    <label for="sub_head" class="form-label">Sub Head <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="sub_head" name="sub_head" placeholder="Enter sub head for Payal account">
                    <small class="text-muted">Required for Payal accounts</small>
                </div>
                
                <div class="col-md-6 mb-3" id="remarks_container">
                    <label for="remarks" class="form-label">Remarks</label>
                    <input type="text" class="form-control" id="remarks" name="remarks" placeholder="Additional notes (optional)">
                </div>
            </div>
            
            <hr class="my-4">
            
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('warehouse_dashboard') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> Record Stock IN
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Recent Stock IN Entries -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Stock IN Entries</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Builty Number</th>
                        <th>Warehouse</th>
                        <th>Account</th>
                        <th>Quantity (MT)</th>
                        <th>Unloader</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_stock_in %}
                        {% for stock in recent_stock_in %}
                        <tr>
                            <td>{{ stock[0] }}</td>
                            <td><strong>{{ stock[1] }}</strong></td>
                            <td>{{ stock[2] }}</td>
                            <td>{{ stock[3] }}</td>
                            <td class="text-end text-success">{{ "%.2f"|format(stock[4]|float) }}</td>
                            <td>{{ stock[5] }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No recent stock IN entries</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set today's date as default
document.getElementById('stock_in_date').valueAsDate = new Date();

// Auto-generate serial number when warehouse is selected
document.getElementById('warehouse_name').addEventListener('change', async function() {
    const warehouseId = this.value;
    if (warehouseId) {
        try {
            const response = await fetch(`/api/next-warehouse-serial/${warehouseId}`);
            const data = await response.json();
            document.getElementById('serial_number').value = data.serial_number;
        } catch (error) {
            console.error('Error fetching serial number:', error);
        }
    }
});

// Auto-fill form when builty is selected (for rake source only)
document.getElementById('builty_number').addEventListener('change', async function() {
    const builtyId = this.value;
    
    if (builtyId) {
        try {
            const response = await fetch(`/api/builty-details/${builtyId}`);
            const data = await response.json();
            
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            // Auto-fill company if found
            if (data.company_id) {
                document.getElementById('company_id').value = data.company_id;
            }
            
            // Auto-fill product if found
            if (data.product_id) {
                document.getElementById('product_id').value = data.product_id;
            }
            
            // Auto-fill quantity
            if (data.quantity_mt) {
                document.getElementById('unloaded_quantity').value = data.quantity_mt.toFixed(2);
            }
            
            // Auto-fill account if present
            if (data.account_id) {
                document.getElementById('account_id').value = data.account_id;
            }
            
            // Auto-fill warehouse if present and if not already selected
            if (data.warehouse_id && !document.getElementById('warehouse_name').value) {
                document.getElementById('warehouse_name').value = data.warehouse_id;
                // Trigger serial number generation
                document.getElementById('warehouse_name').dispatchEvent(new Event('change'));
            }
            
        } catch (error) {
            console.error('Error fetching builty details:', error);
        }
    } else {
        // Clear auto-filled fields when builty is deselected
        document.getElementById('company_id').value = '';
        document.getElementById('product_id').value = '';
        document.getElementById('unloaded_quantity').value = '';
        document.getElementById('account_id').value = '';
    }
});

// Toggle between rake and truck source
document.querySelectorAll('input[name="source_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.value === 'rake') {
            document.getElementById('rake_section').style.display = 'block';
            document.getElementById('truck_section').style.display = 'none';
            document.getElementById('builty_number').removeAttribute('disabled');
            document.getElementById('truck_number').setAttribute('disabled', 'disabled');
        } else {
            document.getElementById('rake_section').style.display = 'none';
            document.getElementById('truck_section').style.display = 'block';
            document.getElementById('builty_number').setAttribute('disabled', 'disabled');
            document.getElementById('truck_number').removeAttribute('disabled');
            
            // Clear builty auto-filled data when switching to truck mode
            document.getElementById('builty_number').value = '';
            document.getElementById('company_id').value = '';
            document.getElementById('product_id').value = '';
            document.getElementById('unloaded_quantity').value = '';
            document.getElementById('account_id').value = '';
        }
    });
});

// Toggle Sub Head field based on account type
function toggleSubHead() {
    const accountSelect = document.getElementById('account_id');
    const selectedOption = accountSelect.options[accountSelect.selectedIndex];
    const accountType = selectedOption.dataset.type;
    const subHeadContainer = document.getElementById('sub_head_container');
    const subHeadInput = document.getElementById('sub_head');
    const remarksContainer = document.getElementById('remarks_container');
    
    if (accountType === 'Payal') {
        subHeadContainer.style.display = 'block';
        subHeadInput.required = true;
        // Adjust remarks container to next row
        remarksContainer.classList.remove('col-md-6');
        remarksContainer.classList.add('col-md-12');
    } else {
        subHeadContainer.style.display = 'none';
        subHeadInput.required = false;
        subHeadInput.value = '';
        remarksContainer.classList.remove('col-md-12');
        remarksContainer.classList.add('col-md-6');
    }
}

// Form submission validation for sub_head
document.querySelector('form').addEventListener('submit', function(e) {
    const accountSelect = document.getElementById('account_id');
    const selectedOption = accountSelect.options[accountSelect.selectedIndex];
    const accountType = selectedOption.dataset.type;
    
    if (accountType === 'Payal') {
        const subHead = document.getElementById('sub_head').value.trim();
        if (!subHead) {
            e.preventDefault();
            alert('Sub Head is required for Payal accounts!');
            return false;
        }
    }
});
</script>
{% endblock %}
